<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MILCHICK: Material Integration Leveraging Creative Human-LLM Intelligence Colors Kit</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --md-sys-color-primary-light: #6750A4;
            --md-sys-color-on-primary-light: #FFFFFF;
            --md-sys-color-primary-container-light: #EADDFF;
            --md-sys-color-on-primary-container-light: #21005D;
            --md-sys-color-secondary-light: #625B71;
            --md-sys-color-on-secondary-light: #FFFFFF;
            --md-sys-color-secondary-container-light: #E8DEF8;
            --md-sys-color-on-secondary-container-light: #1D192B;
            --md-sys-color-tertiary-light: #7D5260;
            --md-sys-color-on-tertiary-light: #FFFFFF;
            --md-sys-color-tertiary-container-light: #FFD8E4;
            --md-sys-color-on-tertiary-container-light: #31111D;
            --md-sys-color-error-light: #B3261E;
            --md-sys-color-on-error-light: #FFFFFF;
            --md-sys-color-error-container-light: #F9DEDC;
            --md-sys-color-on-error-container-light: #410E0B;
            --md-sys-color-background-light: #FFFBFE;
            --md-sys-color-on-background-light: #1C1B1F;
            --md-sys-color-surface-light: #FFFBFE;
            --md-sys-color-on-surface-light: #1C1B1F;
            --md-sys-color-surface-variant-light: #E7E0EC;
            --md-sys-color-on-surface-variant-light: #49454F;
            --md-sys-color-outline-light: #79747E;
            --md-sys-color-outline-variant-light: #CAC4D0;
            --md-sys-color-shadow-light: #000000;
            --md-sys-color-scrim-light: #000000;
            --md-sys-color-inverse-surface-light: #313033;
            --md-sys-color-inverse-on-surface-light: #F4EFF4;
            --md-sys-color-inverse-primary-light: #D0BCFF;
            --md-sys-color-primary-dark: #D0BCFF;
            --md-sys-color-on-primary-dark: #381E72;
            --md-sys-color-primary-container-dark: #4F378B;
            --md-sys-color-on-primary-container-dark: #EADDFF;
            --md-sys-color-secondary-dark: #CCC2DC;
            --md-sys-color-on-secondary-dark: #332D41;
            --md-sys-color-secondary-container-dark: #4A4458;
            --md-sys-color-on-secondary-container-dark: #E8DEF8;
            --md-sys-color-tertiary-dark: #EFB8C8;
            --md-sys-color-on-tertiary-dark: #492532;
            --md-sys-color-tertiary-container-dark: #633B48;
            --md-sys-color-on-tertiary-container-dark: #FFD8E4;
            --md-sys-color-error-dark: #F2B8B5;
            --md-sys-color-on-error-dark: #601410;
            --md-sys-color-error-container-dark: #8C1D18;
            --md-sys-color-on-error-container-dark: #F9DEDC;
            --md-sys-color-background-dark: #1C1B1F;
            --md-sys-color-on-background-dark: #E6E1E5;
            --md-sys-color-surface-dark: #1C1B1F;
            --md-sys-color-on-surface-dark: #E6E1E5;
            --md-sys-color-surface-variant-dark: #49454F;
            --md-sys-color-on-surface-variant-dark: #CAC4D0;
            --md-sys-color-outline-dark: #938F99;
            --md-sys-color-outline-variant-dark: #49454F;
            --md-sys-color-shadow-dark: #000000;
            --md-sys-color-scrim-dark: #000000;
            --md-sys-color-inverse-surface-dark: #E6E1E5;
            --md-sys-color-inverse-on-surface-dark: #313033;
            --md-sys-color-inverse-primary-dark: #6750A4;
            --comp-font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --comp-border-radius: 4px;

            --radio-chip-bg: var(--md-sys-color-surface-variant-light);
            --radio-chip-border: var(--md-sys-color-outline-variant-light);
            --radio-chip-text: var(--md-sys-color-on-surface-variant-light);
            --radio-chip-hover-bg: color-mix(in srgb, var(--md-sys-color-primary-light) 10%, transparent);
            --radio-chip-hover-border: var(--md-sys-color-primary-light);
            --radio-chip-selected-bg: var(--md-sys-color-primary-light);
            --radio-chip-selected-border: var(--md-sys-color-primary-light);
            --radio-chip-selected-text: var(--md-sys-color-on-primary-light);
        }

        .dark-theme {
            --radio-chip-bg: var(--md-sys-color-surface-variant-dark);
            --radio-chip-border: var(--md-sys-color-outline-variant-dark);
            --radio-chip-text: var(--md-sys-color-on-surface-variant-dark);
            --radio-chip-hover-bg: color-mix(in srgb, var(--md-sys-color-primary-dark) 10%, transparent);
            --radio-chip-hover-border: var(--md-sys-color-primary-dark);
            --radio-chip-selected-bg: var(--md-sys-color-primary-dark);
            --radio-chip-selected-border: var(--md-sys-color-primary-dark);
            --radio-chip-selected-text: var(--md-sys-color-on-primary-dark);

            background-color: var(--md-sys-color-background-dark);
            color: var(--md-sys-color-on-background-dark);
        }

        body {
            font-family: var(--comp-font-family);
            line-height: 1.6;
            background-color: var(--md-sys-color-background-light);
            color: var(--md-sys-color-on-background-light);
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
            position: relative;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
        }

        #theme-toggle {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant-light);
            padding: 8px;
            border-radius: 50%;
        }

        #theme-toggle:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-on-surface-variant-light) 10%, transparent);
        }

        .dark-theme #theme-toggle {
            color: var(--md-sys-color-on-surface-variant-dark);
        }

        .dark-theme #theme-toggle:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-on-surface-variant-dark) 10%, transparent);
        }

        .main-layout {
            display: grid;
            grid-template-columns: minmax(300px, 1fr) 2fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            #theme-toggle {
                top: 10px;
                right: 15px;
            }
        }

        .card {
            background-color: var(--md-sys-color-surface-light);
            border-radius: 12px;
            border: 1px solid var(--md-sys-color-outline-variant-light);
            padding: 25px;
            margin-bottom: 25px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .dark-theme .card {
            background-color: var(--md-sys-color-surface-dark);
            border-color: var(--md-sys-color-outline-variant-dark);
        }

        h1,
        h2,
        h3,
        h4,
        h5 {
            margin-bottom: 0.8em;
            color: var(--md-sys-color-on-surface-light);
            font-weight: 600;
        }

        .dark-theme h1,
        .dark-theme h2,
        .dark-theme h3,
        .dark-theme h4,
        .dark-theme h5 {
            color: var(--md-sys-color-on-surface-dark);
        }

        h1 {
            font-size: 1.8em;
            margin-bottom: 1em;
        }

        h2 {
            margin-top: 1.5em;
            font-size: 1.4em;
        }

        h3 {
            margin-top: 1em;
            font-size: 1.15em;
            border-bottom: 1px solid var(--md-sys-color-outline-variant-light);
            padding-bottom: 0.4em;
        }

        .dark-theme h3 {
            border-bottom-color: var(--md-sys-color-outline-variant-dark);
        }

        h4 {
            font-size: 1em;
            margin-bottom: 0.8em;
            color: var(--md-sys-color-on-surface-variant-light);
            font-weight: 500;
        }

        .dark-theme h4 {
            color: var(--md-sys-color-on-surface-variant-dark);
        }

        h5 {
            font-size: 0.95em;
            margin-bottom: 0.5em;
            font-weight: 500;
        }

        p {
            margin-bottom: 1em;
            color: var(--md-sys-color-on-surface-variant-light);
        }

        .dark-theme p {
            color: var(--md-sys-color-on-surface-variant-dark);
        }

        code {
            background-color: #f0f0f0;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.9em;
            color: #111;
            border: 1px solid #e0e0e0;
        }

        .dark-theme code {
            background-color: #333;
            color: #eee;
            border-color: #555;
        }

        fieldset {
            border: 1px solid var(--md-sys-color-outline-light);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .dark-theme fieldset {
            border-color: var(--md-sys-color-outline-dark);
        }

        legend {
            font-weight: 600;
            padding: 0 8px;
            font-size: 0.95em;
            color: var(--md-sys-color-on-surface-light);
        }

        .dark-theme legend {
            color: var(--md-sys-color-on-surface-dark);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label,
        .checkbox-label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 0.9em;
            color: var(--md-sys-color-on-surface-variant-light);
        }

        .dark-theme .input-group label,
        .dark-theme .checkbox-label {
            color: var(--md-sys-color-on-surface-variant-dark);
        }

        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group select,
        .input-group textarea {
            padding: 10px 12px;
            border: 1px solid var(--md-sys-color-outline-light);
            border-radius: 4px;
            width: 100%;
            margin-bottom: 5px;
            background-color: var(--md-sys-color-surface-light);
            color: var(--md-sys-color-on-surface-light);
            font-size: 0.95em;
            transition: border-color 0.2s ease;
        }

        .dark-theme .input-group input[type="text"],
        .dark-theme .input-group input[type="number"],
        .dark-theme .input-group select,
        .dark-theme .input-group textarea {
            background-color: var(--md-sys-color-surface-dark);
            color: var(--md-sys-color-on-surface-dark);
            border-color: var(--md-sys-color-outline-dark);
        }

        #text-prompt-input {
            font-size: 1.05em;
            padding: 12px;
            min-height: 80px;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: var(--md-sys-color-primary-light);
            outline: 1px solid var(--md-sys-color-primary-light);
        }

        .dark-theme .input-group input:focus,
        .dark-theme .input-group select:focus,
        .dark-theme .input-group textarea:focus {
            border-color: var(--md-sys-color-primary-dark);
            outline-color: var(--md-sys-color-primary-dark);
        }

        .input-group input[type="color"] {
            width: 42px;
            height: 42px;
            padding: 2px;
            vertical-align: middle;
            border: 1px solid var(--md-sys-color-outline-light);
            border-radius: 4px;
            cursor: pointer;
            background-color: #fff;
        }

        .dark-theme .input-group input[type="color"] {
            border-color: var(--md-sys-color-outline-dark);
            background-color: #333;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 3px;
        }

        input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 3px;
        }

        .input-group .color-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .input-group .color-input-row label {
            width: 70px;
            margin-bottom: 0;
            text-align: right;
            font-size: 0.85em;
            color: var(--md-sys-color-on-surface-variant-light);
        }

        .dark-theme .input-group .color-input-row label {
            color: var(--md-sys-color-on-surface-variant-dark);
        }

        .mode-selection {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .mode-selection input[type="radio"] {
            opacity: 0;
            position: absolute;
            width: 1px;
            height: 1px;
        }

        .mode-selection label {
            display: inline-block;
            padding: 6px 14px;
            border: 1px solid var(--radio-chip-border);
            background-color: var(--radio-chip-bg);
            color: var(--radio-chip-text);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            user-select: none;
        }

        .mode-selection label:hover {
            background-color: var(--radio-chip-hover-bg);
            border-color: var(--radio-chip-hover-border);
        }

        .mode-selection input[type="radio"]:checked+label {
            background-color: var(--radio-chip-selected-bg);
            border-color: var(--radio-chip-selected-border);
            color: var(--radio-chip-selected-text);
            font-weight: 500;
        }

        .mode-selection input[type="radio"]:focus-visible+label {
            outline: 2px solid var(--md-sys-color-primary-light);
            outline-offset: 2px;
        }

        .dark-theme .mode-selection input[type="radio"]:focus-visible+label {
            outline-color: var(--md-sys-color-primary-dark);
        }

        .mode-selection label::before,
        .mode-selection label::after {
            display: none;
        }

        .mode-selection div {
            line-height: 1;
        }

        input[type="checkbox"].custom-styled {
            opacity: 0;
            position: absolute;
            width: 1px;
            height: 1px;
        }

        .checkbox-label {
            margin-left: 0;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            position: relative;
            padding-left: 28px;
            min-height: 20px;
            user-select: none;
            color: var(--md-sys-color-on-surface-light);
        }

        .dark-theme .checkbox-label {
            color: var(--md-sys-color-on-surface-dark);
        }

        .checkbox-label::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border: 1px solid var(--md-sys-color-outline-light);
            background-color: var(--md-sys-color-surface-light);
            transition: all 0.2s ease;
            border-radius: 3px;
        }

        .dark-theme .checkbox-label::before {
            border-color: var(--md-sys-color-outline-dark);
            background-color: var(--md-sys-color-surface-dark);
        }

        .checkbox-label:hover::before {
            border-color: var(--md-sys-color-primary-light);
        }

        .dark-theme .checkbox-label:hover::before {
            border-color: var(--md-sys-color-primary-dark);
        }

        input[type="checkbox"].custom-styled:focus-visible+.checkbox-label::before {
            outline: 2px solid var(--md-sys-color-primary-light);
            outline-offset: 2px;
        }

        .dark-theme input[type="checkbox"].custom-styled:focus-visible+.checkbox-label::before {
            outline-color: var(--md-sys-color-primary-dark);
        }

        input[type="checkbox"].custom-styled:checked+.checkbox-label::before {
            border-color: var(--md-sys-color-primary-light);
            background-color: var(--md-sys-color-primary-light);
        }

        .dark-theme input[type="checkbox"].custom-styled:checked+.checkbox-label::before {
            border-color: var(--md-sys-color-primary-dark);
            background-color: var(--md-sys-color-primary-dark);
        }

        input[type="checkbox"].custom-styled:checked+.checkbox-label::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 50%;
            width: 3px;
            height: 8px;
            border: solid var(--md-sys-color-on-primary-light);
            border-width: 0 2px 2px 0;
            transform: translateY(-60%) rotate(45deg);
        }

        .dark-theme input[type="checkbox"].custom-styled:checked+.checkbox-label::after {
            border-color: var(--md-sys-color-on-primary-dark);
        }

        button:not([id^="md-"]) {
            padding: 10px 18px;
            background-color: var(--md-sys-color-primary-light);
            color: var(--md-sys-color-on-primary-light);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.2s ease, opacity 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            vertical-align: middle;
        }

        .dark-theme button:not([id^="md-"]) {
            background-color: var(--md-sys-color-primary-dark);
            color: var(--md-sys-color-on-primary-dark);
        }

        button:not([id^="md-"]):hover {
            background-color: color-mix(in srgb, var(--md-sys-color-primary-light) 90%, black);
        }

        .dark-theme button:not([id^="md-"]):hover {
            background-color: color-mix(in srgb, var(--md-sys-color-primary-dark) 90%, white);
        }

        button:not([id^="md-"]):disabled {
            background-color: color-mix(in srgb, var(--md-sys-color-on-surface-light) 30%, transparent);
            color: color-mix(in srgb, var(--md-sys-color-on-surface-light) 50%, transparent);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .dark-theme button:not([id^="md-"]):disabled {
            background-color: color-mix(in srgb, var(--md-sys-color-on-surface-dark) 30%, transparent);
            color: color-mix(in srgb, var(--md-sys-color-on-surface-dark) 50%, transparent);
        }

        #generate-button {
            width: 100%;
            margin-top: 15px;
            font-size: 1.1em;
            justify-content: center;
        }

        #suggest-colors-button {
            margin-top: 5px;
        }

        #generate-mwc-components-button,
        #generate-gemini-components-button {
            margin-top: 5px;
            /* Reduced margin */
            background-color: var(--md-sys-color-secondary-light);
            color: var(--md-sys-color-on-secondary-light);
            font-size: 0.95em;
        }

        .dark-theme #generate-mwc-components-button,
        .dark-theme #generate-gemini-components-button {
            background-color: var(--md-sys-color-secondary-dark);
            color: var(--md-sys-color-on-secondary-dark);
        }

        #generate-mwc-components-button:hover,
        #generate-gemini-components-button:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-secondary-light) 90%, black);
        }

        .dark-theme #generate-mwc-components-button:hover,
        .dark-theme #generate-gemini-components-button:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-secondary-dark) 90%, white);
        }

        #add-custom-color-button {
            margin-top: 0px;
            font-size: 0.9em;
            padding: 6px 12px;
            background-color: var(--md-sys-color-secondary-container-light);
            color: var(--md-sys-color-on-secondary-container-light);
            border: 1px solid var(--md-sys-color-outline-light);
        }

        .dark-theme #add-custom-color-button {
            background-color: var(--md-sys-color-secondary-container-dark);
            color: var(--md-sys-color-on-secondary-container-dark);
            border-color: var(--md-sys-color-outline-dark);
        }

        #add-custom-color-button:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-secondary-container-light) 90%, black);
        }

        .dark-theme #add-custom-color-button:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-secondary-container-dark) 90%, white);
        }

        #drop-area {
            border: 2px dashed var(--md-sys-color-outline-light);
            border-radius: 4px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            background-color: var(--md-sys-color-surface-variant-light);
            transition: background-color 0.2s ease, border-color 0.2s ease;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .dark-theme #drop-area {
            border-color: var(--md-sys-color-outline-dark);
            background-color: var(--md-sys-color-surface-variant-dark);
        }

        #drop-area.drag-over {
            background-color: var(--md-sys-color-secondary-container-light);
            border-color: var(--md-sys-color-primary-light);
        }

        .dark-theme #drop-area.drag-over {
            background-color: var(--md-sys-color-secondary-container-dark);
            border-color: var(--md-sys-color-primary-dark);
        }

        #drop-area p {
            margin: 0;
            color: var(--md-sys-color-on-surface-variant-light);
            font-size: 0.95em;
        }

        .dark-theme #drop-area p {
            color: var(--md-sys-color-on-surface-variant-dark);
        }

        #image-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 15px;
            border-radius: 4px;
            object-fit: contain;
            border: 1px solid var(--md-sys-color-outline-variant-light);
        }

        .dark-theme #image-preview {
            border-color: var(--md-sys-color-outline-variant-dark);
        }

        .image-options {
            margin-top: 15px;
            border-top: 1px solid var(--md-sys-color-outline-variant-light);
            padding-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dark-theme .image-options {
            border-top-color: var(--md-sys-color-outline-variant-dark);
        }

        .image-options label {
            font-size: 0.85em;
            color: var(--md-sys-color-on-surface-variant-light);
        }

        .dark-theme .image-options label {
            color: var(--md-sys-color-on-surface-variant-dark);
        }

        .image-options input {
            max-width: 70px;
        }

        #custom-color-list .custom-color-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--md-sys-color-outline-variant-light);
            padding: 8px 10px;
            border-radius: 4px;
            background-color: var(--md-sys-color-surface-light);
        }

        .dark-theme #custom-color-list .custom-color-row {
            border-color: var(--md-sys-color-outline-variant-dark);
            background-color: var(--md-sys-color-surface-dark);
        }

        #custom-color-list label {
            margin-bottom: 0;
            font-weight: normal;
            font-size: 0.85em;
            white-space: nowrap;
            color: var(--md-sys-color-on-surface-variant-light);
        }

        .dark-theme #custom-color-list label {
            color: var(--md-sys-color-on-surface-variant-dark);
        }

        #custom-color-list input[type="text"] {
            flex-grow: 1;
            min-width: 80px;
            font-size: 0.9em;
            padding: 6px 8px;
        }

        #custom-color-list input[type="checkbox"] {
            margin-left: 2px;
            transform: scale(0.9);
        }

        #custom-color-list button {
            padding: 3px 7px;
            font-size: 0.8em;
            line-height: 1;
            background-color: transparent;
            border: none;
            color: var(--md-sys-color-error-light);
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }

        .dark-theme #custom-color-list button {
            color: var(--md-sys-color-error-dark);
        }

        #custom-color-list button:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-error-light) 15%, transparent);
        }

        .dark-theme #custom-color-list button:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-error-dark) 15%, transparent);
        }

        .output-section {
            min-height: 300px;
        }

        .output-section .placeholder {
            color: var(--md-sys-color-outline-light);
            text-align: center;
            margin-top: 60px;
            font-style: italic;
            font-size: 0.95em;
        }

        .dark-theme .output-section .placeholder {
            color: var(--md-sys-color-outline-dark);
        }

        .color-group {
            margin-bottom: 30px;
        }

        .swatch-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .swatch {
            width: 110px;
            height: 110px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 8px;
            font-size: 0.8em;
            color: white;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .swatch span {
            display: block;
            line-height: 1.3;
        }

        .swatch .swatch-name {
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .swatch .swatch-hex {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.9em;
            opacity: 0.9;
        }

        #seed-colors-display .swatch {
            width: 70px;
            height: 70px;
            font-size: 0.75em;
            padding: 5px;
        }

        #seed-colors-display h3 {
            border-bottom: none;
            margin-bottom: 0.5em;
        }

        .palette-section {
            margin-bottom: 20px;
        }

        .scheme-swatches {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .custom-color-group-display {
            border-left: 3px solid var(--md-sys-color-outline-variant-light);
            padding-left: 15px;
            margin-left: 5px;
            margin-top: 15px;
        }

        .dark-theme .custom-color-group-display {
            border-left-color: var(--md-sys-color-outline-variant-dark);
        }

        .custom-color-group-display .scheme-pair {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .hidden {
            display: none !important;
        }

        .error {
            color: var(--md-sys-color-error-light);
            background-color: var(--md-sys-color-error-container-light);
            border: 1px solid color-mix(in srgb, var(--md-sys-color-error-light) 30%, transparent);
            padding: 12px 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .dark-theme .error {
            color: var(--md-sys-color-error-dark);
            background-color: var(--md-sys-color-error-container-dark);
            border-color: color-mix(in srgb, var(--md-sys-color-error-dark) 30%, transparent);
        }

        #loading-indicator,
        #suggestion-loading-indicator,
        #gemini-component-loading {
            text-align: center;
            padding: 15px 10px;
            color: var(--md-sys-color-outline-light);
            font-style: italic;
            font-size: 0.95em;
        }

        .dark-theme #loading-indicator,
        .dark-theme #suggestion-loading-indicator,
        .dark-theme #gemini-component-loading {
            color: var(--md-sys-color-outline-dark);
        }

        #text-prompt-options {
            margin: 10px 0 5px 0;
            font-size: 0.85em;
        }

        #text-prompt-suggestions {
            margin-top: 20px;
            border-top: 1px solid var(--md-sys-color-outline-variant-light);
            padding-top: 20px;
        }

        .dark-theme #text-prompt-suggestions {
            border-top-color: var(--md-sys-color-outline-variant-dark);
        }

        #text-prompt-suggestions>label {
            display: block;
            margin-bottom: 12px;
            font-weight: 500;
            font-size: 0.9em;
            color: var(--md-sys-color-on-surface-variant-light);
        }

        .dark-theme #text-prompt-suggestions>label {
            color: var(--md-sys-color-on-surface-variant-dark);
        }

        .suggestion-option {
            padding: 10px 12px;
            border: 1px solid var(--md-sys-color-outline-light);
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            background-color: var(--md-sys-color-surface-light);
        }

        .dark-theme .suggestion-option {
            border-color: var(--md-sys-color-outline-dark);
            background-color: var(--md-sys-color-surface-dark);
        }

        .suggestion-option:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-primary-light) 8%, transparent);
            border-color: var(--md-sys-color-primary-light);
        }

        .dark-theme .suggestion-option:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-primary-dark) 8%, transparent);
            border-color: var(--md-sys-color-primary-dark);
        }

        .suggestion-option.selected {
            border-color: var(--md-sys-color-primary-light);
            background-color: var(--md-sys-color-primary-container-light);
            outline: 1px solid var(--md-sys-color-primary-light);
        }

        .dark-theme .suggestion-option.selected {
            border-color: var(--md-sys-color-primary-dark);
            background-color: var(--md-sys-color-primary-container-dark);
            outline-color: var(--md-sys-color-primary-dark);
        }

        .suggestion-option.selected span:not(.suggestion-swatch) {
            font-weight: 600;
            color: var(--md-sys-color-on-primary-container-light);
        }

        .dark-theme .suggestion-option.selected span:not(.suggestion-swatch) {
            color: var(--md-sys-color-on-primary-container-dark);
        }

        .suggestion-option input[type="radio"] {
            opacity: 0;
            width: 1px;
            height: 1px;
            position: absolute;
        }

        .suggestion-option label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            width: 100%;
            margin: 0;
            font-weight: normal;
            color: var(--md-sys-color-on-surface-light);
        }

        .dark-theme .suggestion-option label {
            color: var(--md-sys-color-on-surface-dark);
        }

        .suggestion-swatch {
            width: 22px;
            height: 22px;
            border-radius: 3px;
            border: 1px solid var(--md-sys-color-outline-variant-light);
            display: inline-block;
            flex-shrink: 0;
        }

        .dark-theme .suggestion-swatch {
            border-color: var(--md-sys-color-outline-variant-dark);
        }

        #component-examples {
            margin-top: 30px;
            border-top: 1px solid var(--md-sys-color-outline-variant-light);
            padding-top: 25px;
        }

        .dark-theme #component-examples {
            border-top-color: var(--md-sys-color-outline-variant-dark);
        }

        #component-examples h3 {
            border-bottom: none;
            margin-bottom: 15px;
        }

        .component-generation-options {
            display: flex;
            flex-direction: column;
            /* Stack vertically first */
            gap: 15px;
            margin-bottom: 15px;
        }

        .component-generation-options .input-group {
            margin-bottom: 0;
            width: 100%;
            /* Make prompt full width */
        }

        .component-buttons-container {
            display: flex;
            flex-wrap: wrap;
            /* Allow wrapping on small screens */
            gap: 15px;
            align-items: center;
            /* Vertically align buttons if they wrap */
        }

        .component-preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1100px) {
            .component-preview-grid {
                grid-template-columns: 1fr;
            }
        }

        .component-preview-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid var(--md-sys-color-outline-variant-light);
            background-color: var(--md-sys-color-background-light);
            color: var(--md-sys-color-on-background-light);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            min-height: 300px;

            /* Apply base theme vars locally */
            background-color: var(--local-sys-color-background, var(--md-sys-color-background-light));
            color: var(--local-sys-color-on-background, var(--md-sys-color-on-background-light));
            border-color: var(--local-sys-color-outline-variant, var(--md-sys-color-outline-variant-light));
        }

        /* Apply specific variables for dark theme within preview */
        .component-preview-area.dark-theme {
            background-color: var(--local-sys-color-background, var(--md-sys-color-background-dark));
            color: var(--local-sys-color-on-background, var(--md-sys-color-on-background-dark));
            border-color: var(--local-sys-color-outline-variant, var(--md-sys-color-outline-variant-dark));
        }

        .component-preview-area h4 {
            color: var(--local-sys-color-on-surface, var(--md-sys-color-on-surface-light));
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .dark-theme .component-preview-area h4 {
            color: var(--local-sys-color-on-surface, var(--md-sys-color-on-surface-dark));
        }

        .component-preview-area h5 {
            color: var(--local-sys-color-on-surface, var(--md-sys-color-on-surface-light));
            margin-bottom: 10px;
            font-size: 1em;
        }

        .dark-theme .component-preview-area h5 {
            color: var(--local-sys-color-on-surface, var(--md-sys-color-on-surface-dark));
        }

        /* Apply local theme vars to MWC components inside preview */
        #mwc-component-preview md-filled-button,
        #mwc-component-preview md-outlined-button,
        #mwc-component-preview md-fab,
        #mwc-component-preview md-chip-set md-assist-chip,
        #mwc-component-preview md-chip-set md-filter-chip,
        #mwc-component-preview md-slider,
        #mwc-component-preview md-card {
            --md-sys-color-primary: var(--local-sys-color-primary);
            --md-sys-color-on-primary: var(--local-sys-color-on-primary);
            --md-sys-color-primary-container: var(--local-sys-color-primary-container);
            --md-sys-color-on-primary-container: var(--local-sys-color-on-primary-container);
            --md-sys-color-secondary: var(--local-sys-color-secondary);
            --md-sys-color-on-secondary: var(--local-sys-color-on-secondary);
            --md-sys-color-secondary-container: var(--local-sys-color-secondary-container);
            --md-sys-color-on-secondary-container: var(--local-sys-color-on-secondary-container);
            --md-sys-color-tertiary: var(--local-sys-color-tertiary);
            --md-sys-color-on-tertiary: var(--local-sys-color-on-tertiary);
            --md-sys-color-tertiary-container: var(--local-sys-color-tertiary-container);
            --md-sys-color-on-tertiary-container: var(--local-sys-color-on-tertiary-container);
            --md-sys-color-error: var(--local-sys-color-error);
            --md-sys-color-on-error: var(--local-sys-color-on-error);
            --md-sys-color-error-container: var(--local-sys-color-error-container);
            --md-sys-color-on-error-container: var(--local-sys-color-on-error-container);
            --md-sys-color-surface: var(--local-sys-color-surface);
            --md-sys-color-on-surface: var(--local-sys-color-on-surface);
            --md-sys-color-surface-variant: var(--local-sys-color-surface-variant);
            --md-sys-color-on-surface-variant: var(--local-sys-color-on-surface-variant);
            --md-sys-color-outline: var(--local-sys-color-outline);
            --md-sys-color-outline-variant: var(--local-sys-color-outline-variant);
            --md-sys-color-inverse-surface: var(--local-sys-color-inverse-surface);
            --md-sys-color-inverse-on-surface: var(--local-sys-color-inverse-on-surface);
            --md-sys-color-inverse-primary: var(--local-sys-color-inverse-primary);
            --md-sys-color-background: var(--local-sys-color-background);
            /* Important for card */
            --md-sys-color-on-background: var(--local-sys-color-on-background);
        }

        #mwc-component-preview md-card p {
            color: var(--local-sys-color-on-surface-variant, var(--md-sys-color-on-surface-variant-light));
        }

        .dark-theme #mwc-component-preview md-card p {
            color: var(--local-sys-color-on-surface-variant, var(--md-sys-color-on-surface-variant-dark));
        }

        #dynamic-theme-styles {}

        /* Ensure Gemini generated content respects dark theme if it doesn't scope itself */
        .dark-theme #gemini-component-preview {
            /* Styles already applied by .component-preview-area.dark-theme */
        }

        /* Specific overrides might be needed if Gemini uses generic tags */
        .dark-theme #gemini-component-preview h1,
        .dark-theme #gemini-component-preview h2,
        .dark-theme #gemini-component-preview h3,
        .dark-theme #gemini-component-preview h4,
        .dark-theme #gemini-component-preview h5 {
            color: var(--local-sys-color-on-surface, var(--md-sys-color-on-surface-dark));
        }

        .dark-theme #gemini-component-preview p,
        .dark-theme #gemini-component-preview li {
            color: var(--local-sys-color-on-surface-variant, var(--md-sys-color-on-surface-variant-dark));
        }

        .dark-theme #gemini-component-preview code {
            background-color: #333;
            color: #eee;
            border-color: #555;
        }

        .dark-theme #gemini-component-preview a {
            color: var(--local-sys-color-primary, var(--md-sys-color-primary-dark));
        }
    </style>
</head>

<body>
    <button id="theme-toggle" title="Toggle Light/Dark Mode">
        <span class="material-icons"></span>
    </button>

    <div class="container">
        <h1>MILCHICK: Material Integration Leveraging Creative Human-LLM Intelligence Colors Kit</h1>
        <p>Generate Material Design 3 color palettes from colors, images, or text prompts. Uses a pure js fork of <a
                href="https://github.com/material-foundation/material-color-utilities/tree/main/typescript"
                target="_blank" rel="noopener">material-color-utilities</a> via <code>dream.js</code>.</p>

        <div class="main-layout">
            <div class="input-section card">
                <h2>Configuration</h2>
                <fieldset class="mode-selection">
                    <legend>Input Mode</legend>
                    <div><input type="radio" id="modeText" name="generationMode" value="modeText" checked><label
                            for="modeText" title="Generate seed colors using a text prompt via Gemini.">Gemini
                            Prompt</label></div>
                    <div><input type="radio" id="mode3" name="generationMode" value="mode3"><label for="mode3"
                            title="Generate theme from a single source color.">Single Source</label></div>
                    <div id="mode4-container"><input type="radio" id="mode4" name="generationMode" value="mode4"><label
                            for="mode4" title="Generate theme from one source plus custom accent colors.">Single +
                            Custom</label></div>
                    <div><input type="radio" id="mode1" name="generationMode" value="mode1"><label for="mode1"
                            title="Generate theme from multiple source colors (Primary, Secondary, Tertiary).">Multiple
                            Sources</label></div>
                    <div id="mode2-container"><input type="radio" id="mode2" name="generationMode" value="mode2"><label
                            for="mode2" title="Generate theme from multiple sources plus custom accent colors.">Multiple
                            + Custom</label></div>
                    <div id="modeImageSingle-container"><input type="radio" id="modeImageSingle" name="generationMode"
                            value="modeImageSingle"><label for="modeImageSingle"
                            title="Generate theme from the single most dominant color in an image.">Image
                            (Single)</label></div>
                    <div id="modeImageMulti-container"><input type="radio" id="modeImageMulti" name="generationMode"
                            value="modeImageMulti"><label for="modeImageMulti"
                            title="Generate theme from multiple seed colors extracted from an image.">Image
                            (Multiple)</label></div>
                </fieldset>

                <div id="text-prompt-area" class="input-group">
                    <label for="text-prompt-input">Describe your theme:</label>
                    <textarea id="text-prompt-input" rows="3"
                        placeholder="e.g., calm ocean sunset, vibrant forest floor..."></textarea>
                    <div id="text-prompt-options">
                        <input type="checkbox" id="use-gemini-simulation" class="custom-styled">
                        <label for="use-gemini-simulation" class="checkbox-label">Use Simulation (Offline)</label>
                    </div>
                    <button type="button" id="suggest-colors-button">Suggest Colors</button>
                    <div id="suggestion-loading-indicator" class="hidden">Getting suggestions...</div>
                    <div id="text-prompt-suggestions" class="hidden"><label>Select a suggested color set:</label></div>
                    <p style="font-size: 0.8em; color: var(--md-sys-color-outline-light); margin-top: 5px;">Select a
                        suggestion to populate Source Colors.</p>
                </div>

                <div id="image-input-area" class="input-group hidden">
                    <label>Upload or Drop Image:</label>
                    <div id="drop-area">
                        <p>Drag & Drop or click</p>
                        <input type="file" id="image-input" accept="image/*" hidden>
                        <img id="image-preview" src="#" alt="Preview" class="hidden" />
                    </div>
                    <div class="image-options hidden" id="image-multi-options">
                        <label for="numSources">Max Colors:</label> <input type="number" id="numSources" value="5"
                            min="1" max="20">
                        <label for="extractQuality">Quality (1=Best):</label> <input type="number" id="extractQuality"
                            value="10" min="1" max="50">
                    </div>
                </div>

                <div id="source-color-area" class="input-group hidden">
                    <label id="source-color-label">Source Color:</label>
                    <div id="source-color-inputs"></div>
                </div>

                <div id="custom-color-area" class="input-group hidden">
                    <label>Custom Accent Colors:</label>
                    <div id="custom-color-list"></div>
                    <button type="button" id="add-custom-color-button">Add Custom</button>
                </div>

                <div id="multi-source-options" class="input-group hidden">
                    <label for="harmonyStrategy">Multi-Color Strategy:</label>
                    <select id="harmonyStrategy">
                        <option value="direct" selected>Direct</option>
                        <option value="harmonized">Harmonized</option>
                    </select>
                </div>

                <button type="button" id="generate-button">Generate Theme</button>
                <div id="loading-indicator" class="hidden">Generating theme...</div>
                <div id="error-message" class="error hidden"></div>
            </div>

            <div class="output-section card">
                <h2>Generated Theme</h2>
                <div id="seed-colors-display" class="color-group">
                    <h3>Seed Color(s) Used</h3>
                    <div class="swatch-container">
                        <p class="placeholder">Seeds appear here.</p>
                    </div>
                </div>
                <hr
                    style="border: none; border-top: 1px solid var(--md-sys-color-outline-variant-light); margin: 25px 0;">
                <div id="palette-display">
                    <p class="placeholder">Configure inputs and click Generate.</p>
                </div>

                <div id="component-examples" class="hidden">
                    <hr
                        style="border: none; border-top: 1px solid var(--md-sys-color-outline-variant-light); margin: 25px 0;">
                    <h3>Component Examples</h3>
                    <div class="component-generation-options">
                        <div class="input-group">
                            <label for="component-style-prompt">Optional Gemini Style Prompt:</label>
                            <input type="text" id="component-style-prompt"
                                placeholder="e.g., modern and clean, playful, brutalist...">
                        </div>
                        <div class="component-buttons-container">
                            <button type="button" id="generate-mwc-components-button"
                                title="Apply theme to standard Material Web Components">Generate deterministic component
                                set</button>
                            <button type="button" id="generate-gemini-components-button"
                                title="Use Gemini to generate styled HTML based on the theme and your style prompt">Generate
                                gemini created component set</button>
                        </div>
                    </div>
                    <div id="gemini-component-loading" class="hidden">Generating Gemini components...</div>

                    <div class="component-preview-grid">
                        <div class="component-preview-area" id="mwc-component-preview">
                            <h4>MWC Preview</h4>
                        </div>
                        <div class="component-preview-area" id="gemini-component-preview">
                            <h4>Gemini Preview</h4>
                        </div>
                    </div>
                </div>

                <style id="dynamic-theme-styles"></style>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="dream.js"></script>

    <script type="module" src="https://cdn.skypack.dev/@material/web/all.js"></script>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const modeRadios = document.querySelectorAll('input[name="generationMode"]');
            const imageInputArea = document.getElementById('image-input-area');
            const dropArea = document.getElementById('drop-area');
            const imageInput = document.getElementById('image-input');
            const imagePreview = document.getElementById('image-preview');
            const imageMultiOptions = document.getElementById('image-multi-options');
            const sourceColorArea = document.getElementById('source-color-area');
            const sourceColorLabel = document.getElementById('source-color-label');
            const sourceColorInputsContainer = document.getElementById('source-color-inputs');
            const customColorArea = document.getElementById('custom-color-area');
            const customColorList = document.getElementById('custom-color-list');
            const addCustomColorButton = document.getElementById('add-custom-color-button');
            const multiSourceOptionsArea = document.getElementById('multi-source-options');
            const harmonyStrategySelect = document.getElementById('harmonyStrategy');
            const generateButton = document.getElementById('generate-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessageDiv = document.getElementById('error-message');
            const seedColorsDisplayContainer = document.getElementById('seed-colors-display').querySelector('.swatch-container');
            const paletteDisplay = document.getElementById('palette-display');
            const numSourcesInput = document.getElementById('numSources');
            const extractQualityInput = document.getElementById('extractQuality');
            const textPromptArea = document.getElementById('text-prompt-area');
            const textPromptInput = document.getElementById('text-prompt-input');
            const useSimulationCheckbox = document.getElementById('use-gemini-simulation');
            const suggestColorsButton = document.getElementById('suggest-colors-button');
            const suggestionLoadingIndicator = document.getElementById('suggestion-loading-indicator');
            const textPromptSuggestionsContainer = document.getElementById('text-prompt-suggestions');
            const componentExamplesDiv = document.getElementById('component-examples');
            const generateMwcComponentsButton = document.getElementById('generate-mwc-components-button');
            const generateGeminiComponentsButton = document.getElementById('generate-gemini-components-button');
            const componentStylePromptInput = document.getElementById('component-style-prompt');
            const geminiComponentLoadingIndicator = document.getElementById('gemini-component-loading');
            const mwcComponentPreview = document.getElementById('mwc-component-preview');
            const geminiComponentPreview = document.getElementById('gemini-component-preview');
            const dynamicThemeStyles = document.getElementById('dynamic-theme-styles');
            const bodyElement = document.body;
            const themeToggleButton = document.getElementById('theme-toggle');
            const themeToggleIcon = themeToggleButton.querySelector('.material-icons');

            const mode4Container = document.getElementById('mode4-container');
            const mode2Container = document.getElementById('mode2-container');
            const modeImageSingleContainer = document.getElementById('modeImageSingle-container');
            const modeImageMultiContainer = document.getElementById('modeImageMulti-container');

            let currentImageFile = null;
            let currentMode = 'modeText';
            let lastGeneratedTheme = null;
            let isDarkMode = false;

            let API_KEY, GEMINI_MODEL, GEMINI_API_ENDPOINT_BASE;
            let GEMINI_API_ENDPOINT_COLOR_PICKER, GEMINI_API_ENDPOINT_COMPONENT_GENERATOR;
            let isApiConfigValid = false;
            let enableCustomColors = true;
            let enableImages = true;


            function initializeApp() {
                loadConfig();
                setupThemeToggle();
                applyFeatureVisibility();
                setupEventListeners();
                updateInputUI(currentMode);
            }

            function loadConfig() {
                try {
                    if (typeof APP_CONFIG === 'undefined') throw new Error("config.js not loaded or APP_CONFIG missing.");
                    enableCustomColors = APP_CONFIG.ENABLE_CUSTOM_COLORS !== undefined ? APP_CONFIG.ENABLE_CUSTOM_COLORS : true;
                    enableImages = APP_CONFIG.ENABLE_IMAGES !== undefined ? APP_CONFIG.ENABLE_IMAGES : true;
                    API_KEY = APP_CONFIG.API_KEY;
                    GEMINI_MODEL = APP_CONFIG.GEMINI_MODEL;
                    const configColorPickerModel = typeof GEMINI_MODEL_COLOR_PICKER !== 'undefined' ? GEMINI_MODEL_COLOR_PICKER : null;
                    const configComponentGenModel = typeof GEMINI_MODEL_COMPONENT_GENERATOR !== 'undefined' ? GEMINI_MODEL_COMPONENT_GENERATOR : null;


                    if (!API_KEY || API_KEY === "YOUR_API_KEY_HERE" || !GEMINI_MODEL) {
                        isApiConfigValid = false;
                        showError("Gemini API config missing. Using simulation.");
                        useSimulationCheckbox.disabled = true;
                        suggestColorsButton.title = "Gemini API not configured.";
                        generateGeminiComponentsButton.disabled = true;
                        generateGeminiComponentsButton.title = "Gemini API not configured.";
                    } else {
                        const modelIdBase = GEMINI_MODEL.startsWith('models/') ? GEMINI_MODEL : `models/${GEMINI_MODEL}`;
                        const modelIdColor = (configColorPickerModel && configColorPickerModel.startsWith('models/')) ? configColorPickerModel : (configColorPickerModel ? `models/${configColorPickerModel}` : modelIdBase);
                        const modelIdComponent = (configComponentGenModel && configComponentGenModel.startsWith('models/')) ? configComponentGenModel : (configComponentGenModel ? `models/${configComponentGenModel}` : modelIdBase);

                        GEMINI_API_ENDPOINT_BASE = `https://generativelanguage.googleapis.com/v1beta/${modelIdBase}`;
                        GEMINI_API_ENDPOINT_COLOR_PICKER = `https://generativelanguage.googleapis.com/v1beta/${modelIdColor}`;
                        GEMINI_API_ENDPOINT_COMPONENT_GENERATOR = `https://generativelanguage.googleapis.com/v1beta/${modelIdComponent}`;

                        isApiConfigValid = true;
                        useSimulationCheckbox.disabled = false;
                        suggestColorsButton.title = "";
                        generateGeminiComponentsButton.disabled = false;
                        generateGeminiComponentsButton.title = "";
                    }
                } catch (error) {
                    console.error("Error loading config.js:", error); showError("Config error. Using simulation, limited features.");
                    isApiConfigValid = false; enableCustomColors = false; enableImages = false;
                    useSimulationCheckbox.checked = true; useSimulationCheckbox.disabled = true; suggestColorsButton.title = "Config error.";
                    generateGeminiComponentsButton.disabled = true; generateGeminiComponentsButton.title = "Config error.";
                }
            }

            function applyFeatureVisibility() {
                if (!enableCustomColors) {
                    [mode4Container, mode2Container, addCustomColorButton].forEach(el => el?.classList.add('hidden'));
                }
                if (!enableImages) {
                    [modeImageSingleContainer, modeImageMultiContainer].forEach(el => el?.classList.add('hidden'));
                }

                const selectedRadio = document.querySelector('input[name="generationMode"]:checked');
                if (selectedRadio?.closest('div')?.classList.contains('hidden')) {
                    currentMode = 'modeText';
                    document.getElementById('modeText').checked = true;
                }
            }

            function setupThemeToggle() {
                const storedTheme = localStorage.getItem('themeMode');
                isDarkMode = storedTheme === 'dark';
                applyTheme();
                themeToggleButton.addEventListener('click', () => {
                    isDarkMode = !isDarkMode;
                    localStorage.setItem('themeMode', isDarkMode ? 'dark' : 'light');
                    applyTheme();
                });
            }

            function applyTheme() {
                bodyElement.classList.toggle('dark-theme', isDarkMode);
                themeToggleIcon.textContent = isDarkMode ? 'light_mode' : 'dark_mode';
                // Apply theme class to preview areas for consistent background/text
                mwcComponentPreview?.classList.toggle('dark-theme', isDarkMode);
                geminiComponentPreview?.classList.toggle('dark-theme', isDarkMode);
                // Re-apply dynamic styles if they exist, as dark mode class change might affect them
                if (lastGeneratedTheme) {
                    applyScopedThemeStyles(lastGeneratedTheme);
                }
            }


            function hexToArgbInt(hex) { if (!hex) return 0; hex = hex.replace('#', ''); if (hex.length === 3) hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2]; if (hex.length !== 6) return 0; return parseInt(`ff${hex}`, 16) | 0; }
            function argbIntToHex(argb) { if (typeof argb !== 'number' || isNaN(argb)) return '#000000'; const r = (argb >> 16) & 0xff; const g = (argb >> 8) & 0xff; const b = argb & 0xff; return `#${[r, g, b].map(c => c.toString(16).padStart(2, '0')).join('')}`; }
            function getContrastColor(hex) { if (!hex || hex.length < 4) return '#000000'; hex = hex.replace('#', ''); if (hex.length === 3) hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2]; if (hex.length !== 6) return '#000000'; const r = parseInt(hex.substring(0, 2), 16); const g = parseInt(hex.substring(2, 4), 16); const b = parseInt(hex.substring(4, 6), 16); const lum = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255; return lum > 0.5 ? '#000000' : '#FFFFFF'; }
            function createSwatchHtml(name, colorInt, extraClass = '') { const hex = argbIntToHex(colorInt); const contrast = getContrastColor(hex); const safeName = name ? String(name).replace(/</g, "<").replace(/>/g, ">") : ''; return `<div class="swatch ${extraClass}" style="background-color: ${hex}; color: ${contrast};" title="${safeName} - ${hex}"><span class="swatch-name">${safeName}</span><span class="swatch-hex">${hex}</span></div>`; }
            function showError(msg) { errorMessageDiv.textContent = msg; errorMessageDiv.classList.remove('hidden'); console.error("Error Displayed:", msg); }
            function hideError() { errorMessageDiv.classList.add('hidden'); errorMessageDiv.textContent = ''; }
            function setUILoading(isLoading) { loadingIndicator.classList.toggle('hidden', !isLoading); generateButton.disabled = isLoading; }
            function setSuggestionLoading(isLoading) { suggestionLoadingIndicator.classList.toggle('hidden', !isLoading); suggestColorsButton.disabled = isLoading; textPromptInput.disabled = isLoading; }
            function setGeminiComponentLoading(isLoading) { geminiComponentLoadingIndicator.classList.toggle('hidden', !isLoading); generateGeminiComponentsButton.disabled = isLoading; }


            function displayTheme(theme) {
                paletteDisplay.innerHTML = ''; lastGeneratedTheme = theme;
                if (!theme?.palettes || !theme?.schemes) { paletteDisplay.innerHTML = '<p class="placeholder error">Invalid theme.</p>'; componentExamplesDiv.classList.add('hidden'); return; }
                ['primary', 'secondary', 'tertiary', 'neutral', 'neutralVariant', 'error'].forEach(key => {
                    if (!theme.palettes[key]) return; const section = document.createElement('div'); section.classList.add('palette-section', 'color-group'); const title = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1'); section.innerHTML = `<h4>${title} Roles</h4>`;
                    const swatches = document.createElement('div'); swatches.classList.add('scheme-swatches'); const capKey = key.charAt(0).toUpperCase() + key.slice(1);
                    const roles = [{ n: `${key}(L)`, k: key }, { n: `On ${key}(L)`, k: `on${capKey}` }, { n: `${key} Cont.(L)`, k: `${key}Container` }, { n: `On ${key} Cont.(L)`, k: `on${capKey}Container` }, { n: `${key}(D)`, k: key, s: 'dark' }, { n: `On ${key}(D)`, k: `on${capKey}`, s: 'dark' }, { n: `${key} Cont.(D)`, k: `${key}Container`, s: 'dark' }, { n: `On ${key} Cont.(D)`, k: `on${capKey}Container`, s: 'dark' }];
                    roles.forEach(r => { const scheme = theme.schemes[r.s || 'light']; if (scheme && scheme[r.k] !== undefined) swatches.innerHTML += createSwatchHtml(r.n, scheme[r.k]); });
                    if (swatches.hasChildNodes()) { section.appendChild(swatches); paletteDisplay.appendChild(section); }
                });
                if (enableCustomColors && theme.customColors?.length > 0) {
                    const customSection = document.createElement('div'); customSection.classList.add('palette-section', 'color-group'); customSection.innerHTML = `<h4>Custom Colors</h4>`;
                    theme.customColors.forEach(group => { if (!group?.color?.value || !group.light || !group.dark) return; const groupDiv = document.createElement('div'); groupDiv.classList.add('custom-color-group-display'); const safeName = (group.color.name || 'Unnamed').replace(/</g, "<").replace(/>/g, ">"); const seedHex = argbIntToHex(group.color.value); const finalHex = argbIntToHex(group.value); groupDiv.innerHTML = `<h5>${safeName}(Seed: ${seedHex}${seedHex !== finalHex ? `, Harmonized: ${finalHex}` : ''})</h5>`; const pairDiv = document.createElement('div'); pairDiv.classList.add('scheme-pair'); const customRoles = [{ n: `Color(L)`, s: 'light', k: 'color' }, { n: `On Color(L)`, s: 'light', k: 'onColor' }, { n: `Container(L)`, s: 'light', k: 'colorContainer' }, { n: `On Container(L)`, s: 'light', k: 'onColorContainer' }, { n: `Color(D)`, s: 'dark', k: 'color' }, { n: `On Color(D)`, s: 'dark', k: 'onColor' }, { n: `Container(D)`, s: 'dark', k: 'colorContainer' }, { n: `On Container(D)`, s: 'dark', k: 'onColorContainer' }]; customRoles.forEach(r => { if (group[r.s]?.[r.k] !== undefined) pairDiv.innerHTML += createSwatchHtml(r.n, group[r.s][r.k]); }); if (pairDiv.hasChildNodes()) groupDiv.appendChild(pairDiv); if (groupDiv.hasChildNodes()) customSection.appendChild(groupDiv); });
                    if (customSection.querySelector('.custom-color-group-display')) paletteDisplay.appendChild(customSection);
                }
                if (!paletteDisplay.hasChildNodes()) { paletteDisplay.innerHTML = '<p class="placeholder">No palettes generated.</p>'; componentExamplesDiv.classList.add('hidden'); }
                else { componentExamplesDiv.classList.remove('hidden'); applyScopedThemeStyles(theme); }
            }

            function updateInputUI(mode) {
                currentMode = mode; hideError(); sourceColorInputsContainer.innerHTML = '';
                textPromptSuggestionsContainer.innerHTML = '<label>Select suggested colors:</label>'; textPromptSuggestionsContainer.classList.add('hidden');
                paletteDisplay.innerHTML = '<p class="placeholder">Configure inputs and click Generate.</p>'; seedColorsDisplayContainer.innerHTML = '<p class="placeholder">Seeds appear here.</p>';
                componentExamplesDiv.classList.add('hidden');

                const showImageInput = enableImages && mode.startsWith('modeImage');
                const showCustomColorArea = enableCustomColors && ['mode4', 'mode2', 'modeImageSingle', 'modeImageMulti', 'modeText'].includes(mode);
                const showMultiSourceOptions = ['mode1', 'mode2', 'modeImageMulti', 'modeText'].includes(mode) && (!mode.startsWith('modeImage') || enableImages);

                imageInputArea.classList.toggle('hidden', !showImageInput); imageMultiOptions.classList.toggle('hidden', mode !== 'modeImageMulti' || !enableImages);
                sourceColorArea.classList.toggle('hidden', showImageInput || mode === 'modeText'); customColorArea.classList.toggle('hidden', !showCustomColorArea);
                multiSourceOptionsArea.classList.toggle('hidden', !showMultiSourceOptions); textPromptArea.classList.toggle('hidden', mode !== 'modeText');

                const isTextMode = mode === 'modeText';
                if (isTextMode && !isApiConfigValid) { useSimulationCheckbox.disabled = true; }
                else if (isTextMode) { useSimulationCheckbox.disabled = false; }


                if (mode === 'mode3' || (mode === 'mode4' && enableCustomColors)) { sourceColorArea.classList.remove('hidden'); sourceColorLabel.textContent = 'Source Color:'; addSourceColorInput(0); }
                else if (mode === 'mode1' || (mode === 'mode2' && enableCustomColors)) { sourceColorArea.classList.remove('hidden'); sourceColorLabel.textContent = 'Source Colors:'; addSourceColorInput(0, 'Primary'); addSourceColorInput(1, 'Secondary'); addSourceColorInput(2, 'Tertiary'); }
                else if (mode === 'modeText') { sourceColorArea.classList.remove('hidden'); sourceColorLabel.textContent = 'Source Colors:'; addSourceColorInput(0, 'Primary', true); addSourceColorInput(1, 'Secondary', true); addSourceColorInput(2, 'Tertiary', true); }
                else if (showImageInput) { if (!currentImageFile) { imagePreview.classList.add('hidden'); imagePreview.src = '#'; } }

                if (showCustomColorArea && customColorList.children.length === 0) { addCustomColorRow(); } else if (!showCustomColorArea) { customColorList.innerHTML = ''; }
            }

            function addSourceColorInput(index, label = '', disabled = false) { const row = document.createElement('div'); row.classList.add('color-input-row'); const id = `source-color-${index}`; const defaults = ['#6750A4', '#625B71', '#7D5260']; const safeLabel = label ? String(label).replace(/</g, "<").replace(/>/g, ">") : ''; const labelHtml = label ? `<label for="${id}">${safeLabel}:</label>` : ''; const inputHtml = `<input type="color" id="${id}" name="${id}" value="${defaults[index] || '#808080'}" ${disabled ? 'disabled' : ''}>`; row.innerHTML = `${labelHtml}${inputHtml}`; sourceColorInputsContainer.appendChild(row); }
            function addCustomColorRow() { const index = Date.now(); const row = document.createElement('div'); row.classList.add('custom-color-row'); row.dataset.id = index; row.innerHTML = `<label for="custom-name-${index}">Name:</label><input type="text" id="custom-name-${index}" value="custom${customColorList.children.length + 1}" placeholder="e.g., Brand"><label for="custom-value-${index}">Value:</label><input type="color" id="custom-value-${index}" value="#808080"><label for="custom-blend-${index}" title="Harmonize">Blend:</label><input type="checkbox" id="custom-blend-${index}" checked class="custom-styled"><label for="custom-blend-${index}" class="checkbox-label"></label><button type="button" class="remove-custom-color" data-id="${index}" title="Remove"><md-icon>delete_outline</md-icon></button>`; customColorList.appendChild(row); row.querySelector('.remove-custom-color').addEventListener('click', (e) => e.target.closest('.custom-color-row')?.remove()); }
            function handleImageFile(file) { if (!file?.type.startsWith('image/')) { showError('Invalid image.'); return; } currentImageFile = file; const reader = new FileReader(); reader.onload = (e) => { imagePreview.src = e.target.result; imagePreview.classList.remove('hidden'); hideError(); }; reader.onerror = () => { showError('Read image failed.'); imagePreview.classList.add('hidden'); imagePreview.src = '#'; currentImageFile = null; }; reader.readAsDataURL(file); }


            async function getGeminiContent(endpoint = GEMINI_API_ENDPOINT_BASE, systemPrompt = "", prompt, isJsonResponse = false) {
                if (!isApiConfigValid) throw new Error("Gemini API not configured.");
                const fullApiUrl = `${endpoint}:generateContent?key=${API_KEY}`;

                const parts = [];
                if (systemPrompt) parts.push({ text: systemPrompt });
                parts.push({ text: prompt });

                const requestBody = {
                    contents: [{ parts: parts }],
                    generationConfig: {
                        temperature: 0.7,
                        max_output_tokens: isJsonResponse ? 800 : 2048
                    }
                };
                if (isJsonResponse) requestBody.generationConfig.response_mime_type = "application/json";

                try {
                    const response = await fetch(fullApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                    if (!response.ok) { let errorBodyText = await response.text(); let errorDetails = errorBodyText; try { errorDetails = JSON.parse(errorBodyText); } catch (e) { } console.error("API Error:", response.status, errorDetails); throw new Error(`API request failed: ${response.status} ${response.statusText}. Details: ${JSON.stringify(errorDetails)}`); }
                    const data = await response.json(); const candidate = data.candidates?.[0];
                    if (!candidate) throw new Error("API response missing candidates.");
                    if (candidate.finishReason && candidate.finishReason !== 'STOP' && candidate.finishReason !== 'MAX_TOKENS') { const safetyInfo = candidate.safetyRatings ? `Safety: ${JSON.stringify(candidate.safetyRatings)}` : ''; throw new Error(`Generation stopped: ${candidate.finishReason}. ${safetyInfo}`); }
                    const contentText = candidate.content?.parts?.[0]?.text; if (!contentText) throw new Error("API response missing text content.");
                    return contentText;
                } catch (error) { console.error("Error during Gemini API call:", error); throw error; }
            }

            async function getGeminiSuggestions(promptText) {
                const GEMINI_COLOR_SYSTEM_PROMPT = `You are a color palette generator. Given a text description, suggest exactly 3 DIFFERENT sets of 3 complementary hex color codes suitable for a Material Design 3 theme (Primary, Secondary, Tertiary). Respond ONLY with a JSON object containing a single key "suggestions" which is an array containing ONE array of 3 hex color strings (e.g., {"suggestions": [["#RRGGBB", "#RRGGBB", "#RRGGBB"], ["#RRGGBB", "#RRGGBB", "#RRGGBB"], ["#RRGGBB", "#RRGGBB", "#RRGGBB"]]}). Do not include any other text, explanations, or markdown formatting. Although the sets are unique and variedd, they must all conform to the prompt description.`;
                const jsonResponse = await getGeminiContent(GEMINI_API_ENDPOINT_COLOR_PICKER, GEMINI_COLOR_SYSTEM_PROMPT, promptText, true);
                try {
                    const parsed = JSON.parse(jsonResponse);
                    if (!parsed || !Array.isArray(parsed.suggestions) || parsed.suggestions.length === 0) throw new Error("JSON missing 'suggestions' array or is empty.");
                    // Allow multiple suggestions if API provides them
                    const isValid = parsed.suggestions.every(s => Array.isArray(s) && s.length === 3 && s.every(c => typeof c === 'string' && /^#[0-9A-F]{6}$/i.test(c)));
                    if (!isValid) throw new Error("'suggestions' has invalid structure/hex.");
                    return parsed;
                } catch (parseError) { console.error("Failed to parse API JSON:", parseError, "\nReceived:", jsonResponse); throw new Error(`Model returned invalid JSON: ${parseError.message}`); }
            }

            async function simulateGeminiCall(promptText) {
                await new Promise(resolve => setTimeout(resolve, 600));
                const predefinedSets = [
                    ["#6750A4", "#625B71", "#7D5260"], // Default Purple/Gray
                    ["#00695C", "#4DB6AC", "#B2DFDB"], // Teal/Green
                    ["#B71C1C", "#EF9A9A", "#FFEBEE"], // Red/Pink
                    ["#0D47A1", "#90CAF9", "#E3F2FD"], // Blue
                    ["#EF6C00", "#FFCA28", "#FFF9C4"]  // Orange/Yellow (Sunset-like)
                ];
                const randomIndex = Math.floor(Math.random() * predefinedSets.length);
                return { suggestions: [predefinedSets[randomIndex]] };
            }

            function displaySuggestions(suggestionData) { textPromptSuggestionsContainer.innerHTML = '<label>Select suggested colors:</label>'; if (!suggestionData?.suggestions?.length) { textPromptSuggestionsContainer.innerHTML += '<p style="color: var(--md-sys-color-outline-light); font-size: 0.9em;">No suggestions generated.</p>'; textPromptSuggestionsContainer.classList.remove('hidden'); return; } suggestionData.suggestions.forEach((colorSet, index) => { if (!Array.isArray(colorSet) || colorSet.length !== 3 || !colorSet.every(c => /^#[0-9A-F]{6}$/i.test(c))) { console.warn(`Skipping invalid suggestion ${index}:`, colorSet); return; } const div = document.createElement('div'); div.classList.add('suggestion-option'); div.dataset.colors = JSON.stringify(colorSet); div.setAttribute('role', 'button'); div.tabIndex = 0; const swatchesHtml = colorSet.map(hex => `<span class="suggestion-swatch" style="background-color: ${hex};" title="${hex}"></span>`).join(''); const radioId = `suggestion_${index}`; div.innerHTML = `<input type="radio" name="sugg" id="${radioId}" value='${JSON.stringify(colorSet)}' class="hidden"><label for="${radioId}">${swatchesHtml}<span>Option ${index + 1}</span></label>`; div.addEventListener('click', handleSuggestionSelection); div.addEventListener('keydown', (e) => { if (e.key === ' ' || e.key === 'Enter') { handleSuggestionSelection.call(div, e); e.preventDefault(); } }); textPromptSuggestionsContainer.appendChild(div); }); if (textPromptSuggestionsContainer.querySelectorAll('.suggestion-option').length > 0) textPromptSuggestionsContainer.classList.remove('hidden'); else { textPromptSuggestionsContainer.innerHTML += '<p style="color: var(--md-sys-color-outline-light);">No valid suggestions.</p>'; textPromptSuggestionsContainer.classList.remove('hidden'); } }
            function handleSuggestionSelection(event) { const selectedDiv = this; event.preventDefault(); const colorsJson = selectedDiv.dataset.colors; if (!colorsJson) return; try { const colors = JSON.parse(colorsJson); if (!Array.isArray(colors) || colors.length !== 3) throw new Error("Invalid color data."); const sourceInputs = sourceColorInputsContainer.querySelectorAll('input[type="color"]'); if (sourceInputs.length < 3) throw new Error("Source inputs missing."); colors.forEach((color, index) => { if (sourceInputs[index]) { sourceInputs[index].value = color; sourceInputs[index].disabled = false; sourceInputs[index].dispatchEvent(new Event('input', { bubbles: true })); } }); document.querySelectorAll('.suggestion-option.selected').forEach(el => el.classList.remove('selected')); selectedDiv.classList.add('selected'); const radio = selectedDiv.querySelector('input[type="radio"]'); if (radio) radio.checked = true; hideError(); } catch (error) { showError(`Apply suggestion failed: ${error.message}`); console.error(error); } }


            function applyScopedThemeStyles(theme) {
                if (!theme?.schemes) return;
                const lightCSS = [], darkCSS = [];
                const previewSelectorBase = `#mwc-component-preview, #gemini-component-preview`;

                for (const [schemeKey, scheme] of Object.entries(theme.schemes)) {
                    const isDark = schemeKey === 'dark';
                    const selector = isDark ? `${previewSelectorBase}.dark-theme` : `${previewSelectorBase}:not(.dark-theme)`;
                    const target = isDark ? darkCSS : lightCSS;
                    target.push(`${selector} {`);
                    for (const [token, value] of Object.entries(scheme)) {
                        const kebab = token.replace(/([A-Z])/g, '-$1').toLowerCase();
                        // Use --local- prefix for scoping within the component previews
                        target.push(`--local-sys-color-${kebab}: ${argbIntToHex(value)};`);
                    }
                    if (enableCustomColors && theme.customColors?.length > 0) {
                        theme.customColors.forEach(customGroup => {
                            if (customGroup[schemeKey]) {
                                const baseName = (customGroup.color.name || 'custom').replace(/[^a-zA-Z0-9_-]/g, '-').replace(/-+/g, '-').toLowerCase();
                                for (const [token, value] of Object.entries(customGroup[schemeKey])) {
                                    const kebab = token.replace(/([A-Z])/g, '-$1').toLowerCase();
                                    target.push(`--local-sys-color-custom-${baseName}-${kebab}: ${argbIntToHex(value)};`);
                                }
                            }
                        });
                    }
                    target.push('}');
                }
                dynamicThemeStyles.textContent = lightCSS.join('\n') + '\n' + darkCSS.join('\n');
                // Re-trigger MWC preview generation if needed, or rely on CSS vars updating
                generateMwcComponents(false); // Pass flag to avoid clearing styles
            }


            function generateMwcComponents(applyStyles = true) {
                if (!lastGeneratedTheme?.schemes) { showError("Generate theme first."); return; }

                // Apply scoped styles if requested (usually on initial generation)
                if (applyStyles) {
                    applyScopedThemeStyles(lastGeneratedTheme);
                }

                const mwcHTML = `<div style="display:flex;flex-direction:column;gap:25px;">
                    <div>
                        <h5>Buttons & FAB</h5>
                        <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
                            <md-filled-button>Filled</md-filled-button>
                            <md-outlined-button>Outlined</md-outlined-button>
                            <md-fab aria-label="Edit">
                                <md-icon slot="icon">edit</md-icon>
                            </md-fab>
                        </div>
                    </div>
                     <div>
                         <h5>Chips</h5>
                         <md-chip-set style="display:flex;flex-wrap:wrap;gap:8px;">
                             <md-assist-chip label="Assist"></md-assist-chip>
                             <md-filter-chip label="Filter" elevated></md-filter-chip>
                             <md-suggestion-chip label="Suggest"></md-suggestion-chip>
                         </md-chip-set>
                    </div>
                    <div>
                        <h5>Slider</h5>
                        <md-slider ticks value="65" style="width: 80%;"></md-slider>
                    </div>
                    <div>
                        <h5>Card</h5>
                        <md-card style="padding:16px;max-width:350px;">
                            <p style="margin:0; font-weight: 500;">The Music Dance Experience is officially CANCELED.</p>
                         </md-card>
                    </div>
                 </div>`;

                mwcComponentPreview.innerHTML = `<h4>MWC Preview</h4> ${mwcHTML}`;
                mwcComponentPreview.classList.toggle('dark-theme', isDarkMode); // Ensure class is correct
            }

            const GEMINI_COMPONENT_SYSTEM_PROMPT = `You are an expert web UI designe and engineer specializing in Material Design 3. You will be given:
1. A Material Design 3 color theme (CSS custom properties following the --local-sys-color-... pattern for light mode, intended to be used within a container). You should create corresponding dark mode styles using a '.dark-theme' class selector and the same --local-sys-color-... variables (which will be dynamically swapped by the parent environment).
2. An optional user style prompt.

Your task is to:
- Create an HTML structure containing the following components:
    - Two buttons: one filled, one outlined.
    - One Floating Action Button (FAB) with an icon (e.g., 'edit' or 'add').
    - Two or three chips (e.g., assist, filter, suggestion).
    - One slider element.
    - One card containing ONLY the text: "The Music Dance Experience is officially CANCELED."
- Apply styling using ONLY inline 'style' attributes or by adding appropriate CSS classes DEFINED WITHIN A SINGLE '<style>' TAG in your response.
- **CRITICAL:** Use the provided --local-sys-color-... CSS variables extensively and semantically for ALL colors (backgrounds, text, borders, icons, states etc.). Apply light mode styles directly and dark mode styles under a '.dark-theme' selector within your generated '<style>' tag. For example: \`button { color: var(--local-sys-color-primary); } .dark-theme button { color: var(--local-sys-color-primary); }\` (The variable values themselves change externally).
- Incorporate the user's style prompt (if provided) to influence visual design (spacing, border-radius, font weights, layout). If no prompt, use a standard, clean Material Design style.
- Ensure the output is visually appealing, uses appropriate spacing/layout, and is functional.
- Respond ONLY with the final combined HTML structure and the single '<style>' tag. Do not include explanations, markdown formatting, <!DOCTYPE>, <html>, <body> tags, or anything else outside the requested component HTML and its associated style block.`;


            async function fetchM3Content() {
                // This function might not be needed if Gemini generates from scratch based on the prompt
                // Keeping it in case it's used for reference or a base structure.
                try {
                    const response = await fetch('m3.txt');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.text();
                } catch (error) {
                    console.error("Failed to fetch m3.txt:", error);
                    showError("Failed to load base component structure (m3.txt). May affect Gemini generation.");
                    return ""; // Return empty string instead of null
                }
            }

            async function generateGeminiComponents() {
                if (!lastGeneratedTheme) { showError("Generate theme first."); return; }
                if (!isApiConfigValid) { showError("Gemini API not configured."); return; }

                setGeminiComponentLoading(true);
                geminiComponentPreview.innerHTML = '';
                hideError();

                try {
                    // const m3Content = await fetchM3Content(); // Optionally load base structure if needed by prompt

                    const stylePrompt = componentStylePromptInput.value.trim();
                    // Convert ARGB numbers in the theme to Hex for the prompt
                    const themeForPrompt = {};
                    for (const [schemeKey, scheme] of Object.entries(lastGeneratedTheme.schemes)) {
                        themeForPrompt[schemeKey] = {};
                        for (const [token, value] of Object.entries(scheme)) {
                            themeForPrompt[schemeKey][token] = argbIntToHex(value);
                        }
                        if (lastGeneratedTheme.customColors) {
                            themeForPrompt[schemeKey].customColors = {};
                            lastGeneratedTheme.customColors.forEach(customGroup => {
                                if (customGroup[schemeKey]) {
                                    const baseName = (customGroup.color.name || 'custom').replace(/[^a-zA-Z0-9_-]/g, '-').replace(/-+/g, '-').toLowerCase();
                                    themeForPrompt[schemeKey].customColors[baseName] = {};
                                    for (const [token, value] of Object.entries(customGroup[schemeKey])) {
                                        themeForPrompt[schemeKey].customColors[baseName][token] = argbIntToHex(value);
                                    }
                                }
                            });
                        }
                    }
                    const themeJsonString = JSON.stringify(themeForPrompt, null, 2);

                    const fullPrompt = `MATERIAL DESIGN 3 THEME (Hex Values for Reference - Use --local-sys-color-... variables in CSS):\n\`\`\`json\n${themeJsonString}\n\`\`\`\n\nUSER STYLE PROMPT: ${stylePrompt || 'Default professional style.'}\n\nGenerate the HTML structure and CSS for the requested components based on the system instructions.`;

                    const generatedHtml = await getGeminiContent(GEMINI_API_ENDPOINT_COMPONENT_GENERATOR, GEMINI_COMPONENT_SYSTEM_PROMPT, fullPrompt, false);

                    // Clean potential markdown code fences from the Gemini response
                    let cleanedHtml = generatedHtml
                        .replace(/^\s*```(?:html|css|javascript|)\s*\n?/im, '') // Remove opening fence (```html, ```css, ``` etc.)
                        .replace(/\n?\s*```\s*$/im, '') // Remove closing fence (```)
                        .trim(); // Remove leading/trailing whitespace

                    geminiComponentPreview.innerHTML = `<h4>Gemini Preview</h4> ${cleanedHtml}`;
                    geminiComponentPreview.classList.toggle('dark-theme', isDarkMode); // Ensure class is correct for Gemini's CSS

                } catch (error) {
                    showError(`Gemini component generation failed: ${error.message}`);
                    geminiComponentPreview.innerHTML = `<p class="error">Failed to generate components via Gemini.</p>`;
                } finally {
                    setGeminiComponentLoading(false);
                }
            }


            function setupEventListeners() {
                modeRadios.forEach(radio => radio.addEventListener('change', (e) => updateInputUI(e.target.value)));
                dropArea.addEventListener('click', () => imageInput.click());
                dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('drag-over'); });
                dropArea.addEventListener('dragleave', () => dropArea.classList.remove('drag-over'));
                dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.classList.remove('drag-over'); if (e.dataTransfer.files.length) handleImageFile(e.dataTransfer.files[0]); });
                imageInput.addEventListener('change', (e) => { if (e.target.files.length) handleImageFile(e.target.files[0]); });
                if (enableCustomColors) addCustomColorButton.addEventListener('click', addCustomColorRow);

                suggestColorsButton.addEventListener('click', async () => {
                    const promptText = textPromptInput.value.trim(); if (!promptText) { showError("Enter theme description."); return; }
                    hideError(); setSuggestionLoading(true); textPromptSuggestionsContainer.classList.add('hidden');
                    try {
                        const useSim = useSimulationCheckbox.checked; const useApi = !useSim && isApiConfigValid;
                        if (useApi) console.log("Calling Gemini API for suggestions..."); else if (!isApiConfigValid && !useSim) { console.warn("API request but invalid config."); showError("API not configured. Check simulation box or configure API."); setSuggestionLoading(false); return; } else console.log("Simulating suggestions...");
                        const fn = useApi ? getGeminiSuggestions : simulateGeminiCall; const data = await fn(promptText); displaySuggestions(data);
                    } catch (error) { showError(`Suggestions failed: ${error.message}`); textPromptSuggestionsContainer.innerHTML = '<label>Select colors:</label><p class="error">Failed load.</p>'; textPromptSuggestionsContainer.classList.remove('hidden'); console.error("Suggest Err:", error); } finally { setSuggestionLoading(false); }
                });

                generateButton.addEventListener('click', async () => {
                    setUILoading(true); paletteDisplay.innerHTML = '<p class="placeholder">Generating...</p>'; seedColorsDisplayContainer.innerHTML = ''; hideError();

                    // Check for dream.js functions
                    if (typeof themeFromSourceColor !== 'function' || (enableImages && (typeof sourceColorFromImage !== 'function' || typeof sourceColorsFromImage !== 'function'))) {
                        showError("Core library (dream.js) or one of its functions is missing/not loaded correctly."); setUILoading(false); return;
                    }
                    try {
                        let theme, seeds = [];
                        const customData = enableCustomColors ? Array.from(customColorList.children).map(row => { const id = row.dataset.id; return { name: row.querySelector(`#custom-name-${id}`)?.value || `c_${id}`, value: hexToArgbInt(row.querySelector(`#custom-value-${id}`)?.value), blend: row.querySelector(`#custom-blend-${id}`)?.checked || false }; }).filter(c => c.value !== 0) : [];

                        let effectiveMode = currentMode;
                        if (!enableCustomColors && (effectiveMode === 'mode4' || effectiveMode === 'mode2')) effectiveMode = effectiveMode === 'mode4' ? 'mode3' : 'mode1';
                        if (!enableImages && (effectiveMode === 'modeImageSingle' || effectiveMode === 'modeImageMulti')) effectiveMode = 'mode3';

                        if (effectiveMode === 'mode3' || effectiveMode === 'mode4') { const input = document.getElementById('source-color-0'); if (!input) throw new Error("Src input missing."); const v = hexToArgbInt(input.value); if (v === 0 && !['#000', '#000000'].includes(input.value.toLowerCase())) throw new Error(`Invalid hex: ${input.value}`); seeds = [v]; theme = themeFromSourceColor(v, customData); }
                        else if (effectiveMode === 'mode1' || effectiveMode === 'mode2' || effectiveMode === 'modeText') { const inputs = [0, 1, 2].map(i => document.getElementById(`source-color-${i}`)); if (inputs.some(i => !i)) throw new Error("Src inputs missing."); const values = inputs.map((input, idx) => { if (input.disabled) return null; const v = hexToArgbInt(input.value); if (v === 0 && !['#000', '#000000'].includes(input.value.toLowerCase())) throw new Error(`Invalid hex ${idx + 1}: ${input.value}`); return v; }).filter(v => v !== null); if (values.length === 0) throw new Error(effectiveMode === 'modeText' ? "Select suggestion or provide source colors." : "Provide color(s)."); seeds = values; const opts = { harmonyStrategy: multiSourceOptionsArea.classList.contains('hidden') ? 'direct' : harmonyStrategySelect.value, customColors: customData }; theme = seeds.length === 1 ? themeFromSourceColor(seeds[0], opts.customColors) : themeFromSourceColors(seeds, opts); }
                        else if (enableImages && (effectiveMode === 'modeImageSingle' || effectiveMode === 'modeImageMulti')) {
                            if (!currentImageFile || !imagePreview.src || imagePreview.src.startsWith('#')) throw new Error("Select image."); const img = await new Promise((res, rej) => { const i = new Image(); i.onload = () => res(i); i.onerror = (e) => rej(new Error(`Img load err: ${e.type || 'error'}`)); i.src = imagePreview.src; if (i.complete && i.naturalWidth) setTimeout(() => res(i), 0); }); // Added timeout for sync complete case
                            if (effectiveMode === 'modeImageSingle') { const srcColor = await sourceColorFromImage(img); if (srcColor === undefined || srcColor === null) throw new Error("Extract dominant failed."); seeds = [srcColor]; theme = themeFromSourceColor(srcColor, customData); }
                            else { const num = parseInt(numSourcesInput.value, 10) || 5; const qual = parseInt(extractQualityInput.value, 10) || 10; const opts = { numSources: num, extractQuality: qual, harmonyStrategy: harmonyStrategySelect.value, customColors: customData }; if (typeof themeFromImageUsingSources === 'function') { theme = await themeFromImageUsingSources(img, opts); try { seeds = await sourceColorsFromImage(img, num, qual); } catch (e) { console.warn("Re-extract seeds failed:", e); seeds = theme?.source ? [theme.source] : []; } } else { seeds = await sourceColorsFromImage(img, num, qual); if (!seeds?.length) throw new Error("Extract colors failed."); theme = themeFromSourceColors(seeds, opts); } }
                        } else { throw new Error('Invalid/Disabled mode.'); }

                        if (theme) { seedColorsDisplayContainer.innerHTML = ''; if (seeds?.length) { seeds.forEach((seed, i) => { if (typeof seed === 'number') seedColorsDisplayContainer.innerHTML += createSwatchHtml(`Seed ${i + 1}`, seed, 'seed-swatch'); }); } else if (theme.source) { seedColorsDisplayContainer.innerHTML = createSwatchHtml(`Source`, theme.source, 'seed-swatch'); } else { seedColorsDisplayContainer.innerHTML = '<p style="font-size:0.9em;color:var(--md-sys-color-outline-light);">Seeds unavailable.</p>'; } displayTheme(theme); }
                        else { showError('Generation failed.'); paletteDisplay.innerHTML = '<p class="placeholder error">Failed.</p>'; }
                    } catch (error) { showError(`Gen Error: ${error.message}`); paletteDisplay.innerHTML = '<p class="placeholder error">Error.</p>'; console.error("Gen Error:", error); } finally { setUILoading(false); }
                });

                generateMwcComponentsButton.addEventListener('click', () => generateMwcComponents(true)); // Apply styles on click
                generateGeminiComponentsButton.addEventListener('click', generateGeminiComponents);
            }

            initializeApp();

        });
    </script>

</body>

</html>